"""
–ù–ê–ì–õ–Ø–î–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï: RSA —Å OAEP vs RSA –±–µ–∑ OAEP
"""
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP, PKCS1_v1_5
from Crypto.Hash import SHA256
import time

class RSAComparison:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π RSA
    """
    
    def __init__(self):
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        self.key = RSA.generate(2048)
        self.pub = self.key.publickey()
        
    def demo_plain_rsa(self):
        """
        –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è 1: –°—ã—Ä–æ–π RSA (–±–µ–∑ padding) - –¢–ê–ö –ù–ï–õ–¨–ó–Ø –î–ï–õ–ê–¢–¨!
        """
        print("\n" + "=" * 70)
        print("üî¥ 1. –°–´–†–û–ô RSA (–ë–ï–ó PADDING) - –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û!")
        print("=" * 70)
        
        message = "–ü—Ä–∏–≤–µ—Ç!"
        print(f"\n–°–æ–æ–±—â–µ–Ω–∏–µ: '{message}'")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∏—Å–ª–æ
        m = int.from_bytes(message.encode(), 'big')
        print(f"   ‚Üí –∫–∞–∫ —á–∏—Å–ª–æ: {m}")
        
        # –®–∏—Ñ—Ä—É–µ–º: c = m^e mod n
        c = pow(m, self.pub.e, self.pub.n)
        print(f"   ‚Üí –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: {c}")
        
        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º: m = c^d mod n
        m_dec = pow(c, self.key.d, self.key.n)
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        try:
            decrypted = m_dec.to_bytes((m_dec.bit_length() + 7) // 8, 'big').decode()
            print(f"   ‚Üí —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: '{decrypted}'")
        except:
            print(f"   ‚Üí –æ—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è")
        
        # –ü–†–û–ë–õ–ï–ú–ê 1: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —à–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç
        print("\nüìå –ü–†–û–ë–õ–ï–ú–ê 1: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å")
        c1 = pow(m, self.pub.e, self.pub.n)
        c2 = pow(m, self.pub.e, self.pub.n)
        print(f"   –®–∏—Ñ—Ä—É–µ–º –¥–≤–∞–∂–¥—ã:")
        print(f"   1-–π —Ä–∞–∑: {c1}")
        print(f"   2-–π —Ä–∞–∑: {c2}")
        print(f"   –°–æ–≤–ø–∞–¥–∞—é—Ç: {c1 == c2} ‚ö†Ô∏è")
        print("   ‚Üí –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–∏–¥–∏—Ç, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!")
        
        # –ü–†–û–ë–õ–ï–ú–ê 2: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
        print("\nüìå –ü–†–û–ë–õ–ï–ú–ê 2: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏")
        c_corrupted = c1 ^ 0x01  # –ú–µ–Ω—è–µ–º –æ–¥–∏–Ω –±–∏—Ç
        print(f"   –ü–æ–≤—Ä–µ–∂–¥–∞–µ–º —à–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç: {c_corrupted}")
        m_corrupted = pow(c_corrupted, self.key.d, self.key.n)
        print(f"   –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç—Å—è: {m_corrupted} (—Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã!)")
        
        return c1
    
    def demo_rsa_with_oaep(self):
        """
        –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è 2: RSA —Å OAEP - –ü–†–ê–í–ò–õ–¨–ù–û!
        """
        print("\n" + "=" * 70)
        print("‚úÖ 2. RSA –° OAEP - –ë–ï–ó–û–ü–ê–°–ù–û!")
        print("=" * 70)
        
        message = "–ü—Ä–∏–≤–µ—Ç!"
        print(f"\n–°–æ–æ–±—â–µ–Ω–∏–µ: '{message}'")
        
        # –°–æ–∑–¥–∞–µ–º cipher —Å OAEP
        cipher = PKCS1_OAEP.new(self.pub, hashAlgo=SHA256)
        
        # –®–∏—Ñ—Ä—É–µ–º
        encrypted = cipher.encrypt(message.encode())
        print(f"\n   –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: {len(encrypted)} –±–∞–π—Ç")
        print(f"   HEX: {encrypted.hex()[:50]}...")
        
        # –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 1: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        print("\nüìå –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 1: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ")
        encrypted2 = cipher.encrypt(message.encode())
        print(f"   1-–π —Ä–∞–∑: {encrypted.hex()[:50]}...")
        print(f"   2-–π —Ä–∞–∑: {encrypted2.hex()[:50]}...")
        print(f"   –†–∞–∑–Ω—ã–µ: {encrypted != encrypted2} ‚úÖ")
        print("   ‚Üí –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ù–ï –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –Ω–µ—Ç")
        
        # –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
        print("\nüìå –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏")
        corrupted = bytearray(encrypted)
        corrupted[10] ^= 0xFF
        corrupted = bytes(corrupted)
        
        cipher_dec = PKCS1_OAEP.new(self.key, hashAlgo=SHA256)
        try:
            cipher_dec.decrypt(corrupted)
            print("   ‚ùå –û–®–ò–ë–ö–ê: –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–ª–∏—Å—å!")
        except Exception as e:
            print(f"   ‚úÖ OAEP –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ: {e}")
        
        # –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 3: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
        print("\nüìå –ü–†–ï–ò–ú–£–©–ï–°–¢–í–û 3: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞")
        decrypted = cipher_dec.decrypt(encrypted)
        print(f"   –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: '{decrypted.decode()}' ‚úÖ")
    
    def demo_pkcs1_v1_5(self):
        """
        –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è 3: PKCS#1 v1.5 (—Å—Ç–∞—Ä—ã–π, –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
        """
        print("\n" + "=" * 70)
        print("üü° 3. PKCS#1 v1.5 - –£–°–¢–ê–†–ï–í–®–ò–ô (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)")
        print("=" * 70)
        
        message = "–ü—Ä–∏–≤–µ—Ç!"
        print(f"\n–°–æ–æ–±—â–µ–Ω–∏–µ: '{message}'")
        
        # –°–æ–∑–¥–∞–µ–º cipher —Å–æ —Å—Ç–∞—Ä—ã–º padding
        cipher = PKCS1_v1_5.new(self.pub)
        
        # –®–∏—Ñ—Ä—É–µ–º
        encrypted = cipher.encrypt(message.encode())
        print(f"\n   –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: {len(encrypted)} –±–∞–π—Ç")
        
        # –ü–†–û–ë–õ–ï–ú–ê: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
        print("\nüìå –ü–†–û–ë–õ–ï–ú–ê: –í—Å–µ –µ—â–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π?")
        encrypted2 = cipher.encrypt(message.encode())
        print(f"   –°–æ–≤–ø–∞–¥–∞—é—Ç: {encrypted == encrypted2}")
        
        # –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ê—Ç–∞–∫–∞ –Ω–∞ padding oracle
        print("\nüìå –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ü–æ–¥–≤–µ—Ä–∂–µ–Ω –∞—Ç–∞–∫–∞–º –Ω–∞ padding oracle")
        print("   ‚Üí PKCS#1 v1.5 –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ padding –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö")
        print("   ‚Üí –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫—É –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ")
    
    def run_all_comparisons(self):
        """
        –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
        """
        print("\n" + "=" * 70)
        print("     –ù–ê–ì–õ–Ø–î–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ê–õ–ò–ó–ê–¶–ò–ô RSA")
        print("=" * 70)
        
        # 1. –°—ã—Ä–æ–π RSA (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)
        self.demo_plain_rsa()
        
        # 2. RSA —Å OAEP (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)
        self.demo_rsa_with_oaep()
        
        # 3. PKCS#1 v1.5 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
        self.demo_pkcs1_v1_5()
        
        print("\n" + "=" * 70)
        print("                     –ò–¢–û–ì")
        print("=" * 70)
        print("""
üî¥ –°–´–†–û–ô RSA (–±–µ–∑ padding):
   ‚Ä¢ –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π - –æ–ø–∞—Å–Ω–æ!
   ‚Ä¢ –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
   ‚Ä¢ –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨!

üü° PKCS#1 v1.5:
   ‚Ä¢ –£—è–∑–≤–∏–º –¥–ª—è padding oracle –∞—Ç–∞–∫
   ‚Ä¢ –°—á–∏—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º
   ‚Ä¢ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

‚úÖ RSA –° OAEP (–≤–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è):
   ‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
   ‚Ä¢ –£—Å—Ç–æ–π—á–∏–≤ –∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –∞—Ç–∞–∫–∞–º
   ‚Ä¢ –°–û–í–†–ï–ú–ï–ù–ù–´–ô –°–¢–ê–ù–î–ê–†–¢!
        """)

class VisualTest:
    """
    –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    """
    
    @staticmethod
    def test_your_implementation():
        """
        –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏
        """
        from utils import encrypt_message, decrypt_message
        
        print("\n" + "=" * 70)
        print("     –¢–ï–°–¢ –í–ê–®–ï–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò")
        print("=" * 70)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏
        from utils import generate_keys, load_keys
        generate_keys("test_visual")
        priv, pub = load_keys("test_visual")
        
        # –¢–µ—Å—Ç 1: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ—Å—Ç—å
        print("\nüìä –¢–µ—Å—Ç 1: –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ—Å—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è")
        message = "–°–µ–∫—Ä–µ—Ç–Ω–æ"
        
        encrypted1 = encrypt_message(message, pub)
        encrypted2 = encrypt_message(message, pub)
        
        print(f"   –®–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç 1: {encrypted1.hex()[:40]}...")
        print(f"   –®–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç 2: {encrypted2.hex()[:40]}...")
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {'‚úÖ –†–ê–ó–ù–´–ï' if encrypted1 != encrypted2 else '‚ùå –û–î–ò–ù–ê–ö–û–í–´–ï'}")
        
        # –¢–µ—Å—Ç 2: –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
        print("\nüìä –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏")
        corrupted = bytearray(encrypted1)
        corrupted[5] ^= 0xFF
        corrupted = bytes(corrupted)
        
        try:
            decrypt_message(corrupted, priv)
            print("   ‚ùå –û–®–ò–ë–ö–ê: –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–ª–∏—Å—å!")
        except Exception as e:
            print(f"   ‚úÖ –£—Å–ø–µ—Ö: –û—à–∏–±–∫–∞ '{e}' - —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞!")
        
        # –¢–µ—Å—Ç 3: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
        print("\nüìä –¢–µ—Å—Ç 3: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏")
        decrypted = decrypt_message(encrypted1, priv)
        print(f"   –û—Ä–∏–≥–∏–Ω–∞–ª: '{message}'")
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: '{decrypted}'")
        print(f"   –°–æ–≤–ø–∞–¥–∞—é—Ç: {message == decrypted} ‚úÖ")
        
        return encrypted1 != encrypted2

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    comp = RSAComparison()
    comp.run_all_comparisons()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
    VisualTest.test_your_implementation()